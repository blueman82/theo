# PRODUCERS: Task 2 → memories/memories_vec/memories_fts tables, Task 3 → search methods
# CONSUMERS: Task 4 → [3], Task 8 → [3, 7], Task 9 → [6, 8], Task 10 → [9], Task 5 → [9]
# VALIDATION: All consumers depend_on producers ✓

conductor:
  worktree_groups:
    - group_id: "foundation"
      tasks: [1, 2, 3]
      rationale: "Core sqlite-vec extension and schema - sequential dependency"
    - group_id: "types-config"
      tasks: [6, 7]
      rationale: "Config and types updates - can run in parallel"
    - group_id: "storage-layer"
      tasks: [4, 8]
      rationale: "Storage layer updates after foundation complete"
    - group_id: "entry-point"
      tasks: [9]
      rationale: "Main entry point after storage layer"
    - group_id: "consumers"
      tasks: [5, 10]
      rationale: "Tools and validation - consumers of storage layer"
    - group_id: "cleanup"
      tasks: [11, 12, 13, 14]
      rationale: "Final cleanup, migration, tests, dependency removal"

planner_compliance:
  planner_version: "4.0.0"
  strict_enforcement: true
  required_features: [dependency_checks, test_commands, success_criteria, data_flow_registry]

data_flow_registry:
  producers:
    sqlite_vec_tables:
      - task: 2
        description: "Creates memories, memories_vec, memories_fts, embedding_cache tables"
    search_methods:
      - task: 3
        description: "Creates add_memory, search_vector, search_fts, search_hybrid methods"
    updated_types:
      - task: 7
        description: "Updates Document/SearchResult with SQLite methods"
    updated_config:
      - task: 6
        description: "Removes chroma_path from TheoSettings"
  consumers:
    sqlite_vec_tables:
      - task: 3
        description: "Uses tables for search method implementations"
    search_methods:
      - task: 4
        description: "HybridStore uses SQLiteStore search methods"
      - task: 8
        description: "Storage __init__ exports SQLiteStore"
      - task: 9
        description: "__main__ initializes SQLiteStore"
    updated_config:
      - task: 9
        description: "__main__ uses updated config"

plan:
  metadata:
    feature_name: "sqlite-vec Migration"
    created: "2026-01-27"
    target: "Replace ChromaDB with sqlite-vec + FTS5 for vector storage"
  context:
    framework: "Python 3.13"
    test_framework: "pytest"
  tasks:
    # =========================================================================
    # FOUNDATION GROUP
    # =========================================================================
    - task_number: "1"
      name: "Add sqlite-vec dependency"
      agent: "python-pro"
      files:
        - "pyproject.toml"
      depends_on: []

      success_criteria:
        - "sqlite-vec>=0.1.6 added to dependencies in pyproject.toml"
        - "chromadb dependency remains until task 14"
        - "uv sync succeeds without errors"
        - "uv run python -c 'import sqlite_vec' succeeds"
        - "No TODO comments in production code"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv sync --dev"
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'import sqlite_vec; print(sqlite_vec)'"

      runtime_metadata:
        dependency_checks:
          - command: "cat /Users/harrison/Documents/Github/theo/pyproject.toml | grep -A20 'dependencies'"
            description: "Verify current dependencies"
        documentation_targets: []

      description: |
        Add sqlite-vec package as dependency to pyproject.toml.

        In [project] dependencies section, ADD:
            "sqlite-vec>=0.1.6",

        Keep chromadb temporarily - needed for migration script in Task 12.
        Run: uv sync --dev

      implementation:
        approach: |
          Add sqlite-vec to dependencies list. Keep chromadb for now.
        key_points:
          - point: "Add sqlite-vec>=0.1.6 to dependencies"
            details: "Vector extension for SQLite, replaces ChromaDB for vector storage"
            reference: "pyproject.toml:[project].dependencies"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv sync --dev"
            exit_on_failure: true

      commit:
        type: "build"
        message: "Add sqlite-vec dependency for vector storage migration"
        files: ["pyproject.toml"]

    - task_number: "2"
      name: "Extend sqlite_store.py with sqlite-vec tables"
      agent: "database-optimizer"
      files:
        - "src/theo/storage/sqlite_store.py"
      depends_on: [1]

      success_criteria:
        - "sqlite-vec extension loaded via sqlite_vec.load(conn)"
        - "memories table created with columns: id, content, content_hash, memory_type, namespace, confidence, importance, source_file, chunk_index, start_line, end_line, created_at, last_accessed, access_count, tags"
        - "memories_vec virtual table created with FLOAT[1024] (MLX dimension)"
        - "memories_fts FTS5 virtual table created with content indexed, id/memory_type/namespace/source_file UNINDEXED"
        - "embedding_cache table created with columns: content_hash, provider, model, embedding, dims, created_at"
        - "Indexes created: idx_memories_type, idx_memories_namespace, idx_memories_confidence, idx_memories_source_file, idx_memories_hash, idx_embedding_cache_hash"
        - "Schema version incremented to 2"
        - "No TODO comments, no placeholder code"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c \"from theo.storage.sqlite_store import SQLiteStore; s = SQLiteStore(); print('Tables created')\""

      runtime_metadata:
        dependency_checks:
          - command: "cd /Users/harrison/Documents/Github/theo && uv run python -c 'import sqlite_vec'"
            description: "Verify sqlite-vec available"
        documentation_targets: []

      description: |
        <exact_sql_schema>
        Add these tables to _init_schema() method:

        ```sql
        -- Memory content and metadata (replaces ChromaDB)
        CREATE TABLE IF NOT EXISTS memories (
            id TEXT PRIMARY KEY,
            content TEXT NOT NULL,
            content_hash TEXT,

            -- Type and scope
            memory_type TEXT NOT NULL DEFAULT 'document',
            namespace TEXT NOT NULL DEFAULT 'default',

            -- Confidence (CRITICAL: >= 0.9 means golden rule)
            confidence REAL NOT NULL DEFAULT 0.3,
            importance REAL NOT NULL DEFAULT 0.5,

            -- Document provenance
            source_file TEXT,
            chunk_index INTEGER DEFAULT 0,
            start_line INTEGER,
            end_line INTEGER,

            -- Timestamps
            created_at REAL NOT NULL,
            last_accessed REAL,
            access_count INTEGER DEFAULT 0,

            -- Additional metadata as JSON
            tags TEXT
        );

        -- Vector embeddings (sqlite-vec) - MLX uses 1024 dimensions
        CREATE VIRTUAL TABLE IF NOT EXISTS memories_vec USING vec0(
            id TEXT PRIMARY KEY,
            embedding FLOAT[1024]
        );

        -- Full-text search (FTS5)
        CREATE VIRTUAL TABLE IF NOT EXISTS memories_fts USING fts5(
            content,
            id UNINDEXED,
            memory_type UNINDEXED,
            namespace UNINDEXED,
            source_file UNINDEXED
        );

        -- Embedding cache (avoid re-computation)
        CREATE TABLE IF NOT EXISTS embedding_cache (
            content_hash TEXT NOT NULL,
            provider TEXT NOT NULL,
            model TEXT NOT NULL,
            embedding BLOB NOT NULL,
            dims INTEGER NOT NULL,
            created_at REAL NOT NULL,
            PRIMARY KEY (content_hash, provider, model)
        );

        -- Indexes for memories
        CREATE INDEX IF NOT EXISTS idx_memories_type ON memories(memory_type);
        CREATE INDEX IF NOT EXISTS idx_memories_namespace ON memories(namespace);
        CREATE INDEX IF NOT EXISTS idx_memories_confidence ON memories(confidence DESC);
        CREATE INDEX IF NOT EXISTS idx_memories_source_file ON memories(source_file);
        CREATE INDEX IF NOT EXISTS idx_memories_hash ON memories(content_hash);
        CREATE INDEX IF NOT EXISTS idx_embedding_cache_hash ON embedding_cache(content_hash);
        ```
        </exact_sql_schema>

        <task_description>
        1. Add import: import sqlite_vec
        2. In __init__, after connection setup: sqlite_vec.load(self._conn)
        3. Add all tables above to _init_schema()
        4. Update schema_version to 2
        </task_description>

      implementation:
        approach: |
          Extend existing _init_schema() with new tables. Load sqlite-vec in __init__.
        key_points:
          - point: "Load sqlite_vec extension in __init__"
            details: "sqlite_vec.load(self._conn) after connection"
            reference: "src/theo/storage/sqlite_store.py:__init__"
          - point: "Create memories table with all fields"
            details: "Exact schema above, confidence field critical for golden rules"
            reference: "src/theo/storage/sqlite_store.py:_init_schema"
          - point: "Create memories_vec with FLOAT[1024]"
            details: "MLX mxbai-embed-large-v1 produces 1024-dim embeddings"
            reference: "src/theo/storage/sqlite_store.py:_init_schema"
          - point: "Create memories_fts for full-text search"
            details: "FTS5 with content indexed, metadata UNINDEXED"
            reference: "src/theo/storage/sqlite_store.py:_init_schema"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/storage/sqlite_store.py && uv run isort src/theo/storage/sqlite_store.py && uv run ruff check src/theo/storage/sqlite_store.py --fix && uv run mypy src/theo/storage/sqlite_store.py --ignore-missing-imports"
            exit_on_failure: true

      commit:
        type: "feat"
        message: "Add sqlite-vec tables: memories, memories_vec, memories_fts, embedding_cache"
        files: ["src/theo/storage/sqlite_store.py"]

    - task_number: "3"
      name: "Add vector and FTS search methods to sqlite_store.py"
      agent: "database-optimizer"
      files:
        - "src/theo/storage/sqlite_store.py"
      depends_on: [2]

      success_criteria:
        - "add_memory() inserts to memories + memories_vec + memories_fts in single transaction"
        - "get_memory(id) retrieves memory with all metadata as dict"
        - "update_memory(id, **fields) updates any field including confidence"
        - "delete_memory(id) removes from all three tables atomically"
        - "list_memories(namespace, memory_type, limit, offset) returns paginated list"
        - "count_memories(namespace, memory_type) returns filtered count"
        - "search_vector(embedding, n_results, where) uses vec_distance_cosine"
        - "search_fts(query, n_results, where) uses FTS5 MATCH with bm25"
        - "search_hybrid(embedding, query, n_results, vector_weight=0.7) combines vector and FTS"
        - "get_cached_embedding(content_hash, provider, model) returns cached embedding or None"
        - "cache_embedding(content_hash, provider, model, embedding) stores in cache"
        - "All methods raise SQLiteStoreError on failure"
        - "No TODO comments, no placeholder code"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c \"from theo.storage.sqlite_store import SQLiteStore; print('Methods available')\""

      runtime_metadata:
        dependency_checks:
          - command: "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.storage.sqlite_store import SQLiteStore'"
            description: "Verify SQLiteStore imports"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: YAGNI, KISS, DRY, Fail Fast, Single Source of Truth.
        PYTHONIC: Full type hints, EAFP (try/except), context managers for transactions.
        CODE REDUCTION:
        - Merge search() and search_raw() → single search() method
        - Use UPSERT for add_memory (handles duplicates)
        - Simplify _generate_id() → use uuid4().hex
        </mandatory_principles>

        <method_signatures>
        ```python
        def add_memory(
            self,
            content: str,
            embedding: list[float],
            memory_type: str = "document",
            namespace: str = "default",
            confidence: float = 0.3,
            importance: float = 0.5,
            source_file: str | None = None,
            chunk_index: int = 0,
            content_hash: str | None = None,
            tags: dict | None = None,
        ) -> str:
            """Add memory to all three tables in single transaction."""

        def get_memory(self, memory_id: str) -> dict | None:
            """Get memory by ID with all metadata."""

        def update_memory(self, memory_id: str, **fields) -> bool:
            """Update memory fields. Returns True if updated."""

        def delete_memory(self, memory_id: str) -> bool:
            """Delete from memories, memories_vec, memories_fts."""

        def search_vector(
            self,
            embedding: list[float],
            n_results: int = 5,
            where: dict | None = None,
        ) -> list[SearchResult]:
            """KNN search using sqlite-vec.
            SQL: SELECT m.*, distance FROM memories m
                 JOIN (SELECT id, distance FROM memories_vec
                       WHERE embedding MATCH ? ORDER BY distance LIMIT ?) v
                 ON m.id = v.id
            """

        def search_fts(
            self,
            query: str,
            n_results: int = 5,
            where: dict | None = None,
        ) -> list[SearchResult]:
            """FTS5 search with BM25 ranking.
            SQL: SELECT m.*, bm25(memories_fts) as score
                 FROM memories_fts f JOIN memories m ON f.id = m.id
                 WHERE memories_fts MATCH ? ORDER BY score LIMIT ?
            """

        def search_hybrid(
            self,
            embedding: list[float],
            query: str,
            n_results: int = 5,
            vector_weight: float = 0.7,
        ) -> list[SearchResult]:
            """Combine vector and FTS results with weighted scoring."""

        def get_cached_embedding(
            self, content_hash: str, provider: str, model: str
        ) -> list[float] | None:
            """Retrieve cached embedding."""

        def cache_embedding(
            self, content_hash: str, provider: str, model: str, embedding: list[float]
        ) -> None:
            """Store embedding in cache."""

        def list_memories(
            self,
            namespace: str | None = None,
            memory_type: str | None = None,
            limit: int = 100,
            offset: int = 0,
        ) -> list[dict]:
            """List memories with optional filters and pagination."""

        def count_memories(
            self,
            namespace: str | None = None,
            memory_type: str | None = None,
        ) -> int:
            """Count memories with optional filters."""
        ```
        </method_signatures>

        <task_description>
        Implement all methods above. Use transactions for multi-table ops.
        Convert cosine distance to similarity: similarity = 1.0 - distance
        </task_description>

      implementation:
        approach: |
          Add methods following existing SQLiteStore patterns. Use transactions.
        key_points:
          - point: "add_memory uses transaction for 3 tables"
            details: "INSERT into memories, memories_vec, memories_fts atomically"
            reference: "src/theo/storage/sqlite_store.py"
          - point: "search_vector with vec_distance_cosine"
            details: "sqlite-vec MATCH operator for KNN search"
            reference: "src/theo/storage/sqlite_store.py"
          - point: "search_hybrid merges results"
            details: "Normalize scores, apply weights, dedupe by ID"
            reference: "src/theo/storage/sqlite_store.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/storage/sqlite_store.py && uv run isort src/theo/storage/sqlite_store.py && uv run ruff check src/theo/storage/sqlite_store.py --fix && uv run mypy src/theo/storage/sqlite_store.py --ignore-missing-imports"
            exit_on_failure: true

      commit:
        type: "feat"
        message: "Add vector search, FTS search, hybrid search, CRUD, and embedding cache"
        files: ["src/theo/storage/sqlite_store.py"]

    # =========================================================================
    # TYPES-CONFIG GROUP (parallel)
    # =========================================================================
    - task_number: "6"
      name: "Update config.py - remove chroma_path"
      agent: "python-pro"
      files:
        - "src/theo/config.py"
      depends_on: []

      success_criteria:
        - "chroma_path field removed from TheoSettings"
        - "collection_name field removed from TheoSettings"
        - "get_chroma_path() method removed if exists"
        - "THEO_DB_PATH env var requirement removed"
        - "THEO_COLLECTION env var requirement removed"
        - "sqlite_path remains as primary storage path"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.config import TheoSettings; print(TheoSettings())'"

      runtime_metadata:
        dependency_checks:
          - command: "cat /Users/harrison/Documents/Github/theo/src/theo/config.py"
            description: "Check current config"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: YAGNI, KISS, Single Source of Truth (sqlite_path only).
        PYTHONIC: Pydantic Settings, type hints, Field defaults.
        </mandatory_principles>

        <task_description>
        Remove ChromaDB config from TheoSettings:
        - Delete chroma_path: Path field
        - Delete collection_name: str field
        - Delete any get_chroma_path() method
        - Keep sqlite_path and get_sqlite_path()

        Update any env var references (THEO_DB_PATH was ChromaDB, remove it).
        </task_description>

      implementation:
        approach: |
          Simple field removal from Pydantic settings class.
        key_points:
          - point: "Remove chroma_path and collection_name"
            details: "These fields no longer needed"
            reference: "src/theo/config.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/config.py && uv run isort src/theo/config.py && uv run ruff check src/theo/config.py --fix && uv run mypy src/theo/config.py --ignore-missing-imports"
            exit_on_failure: true

      commit:
        type: "refactor"
        message: "Remove ChromaDB config (chroma_path, collection_name)"
        files: ["src/theo/config.py"]

    - task_number: "7"
      name: "Update storage/types.py - remove ChromaDB helpers"
      agent: "python-pro"
      files:
        - "src/theo/storage/types.py"
      depends_on: []

      success_criteria:
        - "Document.to_chroma_metadata() method removed"
        - "Document.from_chroma_result() classmethod removed"
        - "SearchResult.from_chroma_result() classmethod removed"
        - "Document.to_dict() method added returning dict matching memories table columns"
        - "Document.from_row(row: sqlite3.Row) classmethod added"
        - "SearchResult.from_sqlite(doc, distance, rank) classmethod added with similarity = 1.0 - distance"
        - "Document dataclass field doc_type renamed to memory_type to match SQLite schema"
        - "Document dataclass field doc_hash renamed to content_hash to match SQLite schema"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.storage.types import Document, SearchResult; print(Document, SearchResult)'"

      runtime_metadata:
        dependency_checks:
          - command: "cat /Users/harrison/Documents/Github/theo/src/theo/storage/types.py"
            description: "Check current types"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: KISS, DRY, keep only what's used.
        PYTHONIC: Dataclasses, type hints, classmethods for factories.
        </mandatory_principles>

        <field_mapping>
        ChromaDB → SQLite field names (for Document dataclass):
        - id → id (unchanged)
        - content → content (unchanged)
        - embedding → embedding (unchanged)
        - metadata.namespace → namespace
        - metadata.doc_type → memory_type (RENAMED)
        - metadata.confidence → confidence
        - metadata.importance → importance
        - metadata.source_file → source_file
        - metadata.doc_hash → content_hash (RENAMED)
        - metadata.chunk_index → chunk_index
        - metadata.start_line → start_line
        - metadata.end_line → end_line
        - metadata.created_at → created_at (ISO string → unix float)
        - metadata.accessed_at → last_accessed (RENAMED, ISO → unix)
        - metadata.access_count → access_count
        - metadata.meta_* → tags (JSON dict)
        </field_mapping>

        <task_description>
        Replace ChromaDB methods with SQLite equivalents:

        Document class:
        - Remove to_chroma_metadata()
        - Remove from_chroma_result()
        - Add to_dict() → dict suitable for SQLite INSERT
        - Add from_row(row: sqlite3.Row) → Document

        SearchResult class:
        - Remove from_chroma_result()
        - Add from_sqlite(doc: Document, distance: float, rank: int = 0) → SearchResult
          where similarity = 1.0 - distance
        </task_description>

      implementation:
        approach: |
          Replace ChromaDB serialization with SQLite row conversion.
        key_points:
          - point: "Document.to_dict() for INSERT"
            details: "Returns dict with column names matching memories table"
            reference: "src/theo/storage/types.py"
          - point: "Document.from_row() for SELECT"
            details: "Creates Document from sqlite3.Row"
            reference: "src/theo/storage/types.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/storage/types.py && uv run isort src/theo/storage/types.py && uv run ruff check src/theo/storage/types.py --fix && uv run mypy src/theo/storage/types.py --ignore-missing-imports"
            exit_on_failure: true

      commit:
        type: "refactor"
        message: "Replace ChromaDB helpers with SQLite serialization in types"
        files: ["src/theo/storage/types.py"]

    # =========================================================================
    # STORAGE LAYER GROUP
    # =========================================================================
    - task_number: "4"
      name: "Update hybrid.py to use SQLiteStore"
      agent: "python-pro"
      files:
        - "src/theo/storage/hybrid.py"
      depends_on: [3]

      success_criteria:
        - "ChromaStore import and usage removed"
        - "HybridStore.__init__ takes SQLiteStore + EmbeddingProvider (no ChromaStore parameter)"
        - "HybridStore.create() factory method updated to not create ChromaStore"
        - "add_memory() delegates to SQLiteStore.add_memory()"
        - "search() delegates to SQLiteStore.search_hybrid()"
        - "get_memory() delegates to SQLiteStore.get_memory()"
        - "delete_memory() delegates to SQLiteStore.delete_memory()"
        - "Edge operations unchanged (already use SQLiteStore)"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.storage.hybrid import HybridStore; print(HybridStore)'"

      runtime_metadata:
        dependency_checks:
          - command: "grep -n 'ChromaStore' /Users/harrison/Documents/Github/theo/src/theo/storage/hybrid.py || echo 'No refs'"
            description: "Find ChromaStore references"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: KISS, Law of Demeter (thin wrapper), Single Source of Truth.
        PYTHONIC: Type hints, delegation pattern.
        CODE REDUCTION: HybridStore becomes thin wrapper - consider if it's even needed.
        </mandatory_principles>

        <task_description>
        Update HybridStore to use SQLiteStore:

        1. Remove: from theo.storage.chroma_store import ChromaStore
        2. Update __init__(self, sqlite_store: SQLiteStore, embedding_client: EmbeddingProvider)
           - Remove chroma_store parameter
        3. Update create() factory - don't create ChromaStore
        4. Change method delegations:
           - self._chroma.add_documents() → self._sqlite.add_memory()
           - self._chroma.search() → self._sqlite.search_hybrid()
           - self._chroma.get() → self._sqlite.get_memory()
           - self._chroma.delete() → self._sqlite.delete_memory()
        5. Keep edge operations (already use SQLiteStore)
        </task_description>

      implementation:
        approach: |
          Replace ChromaStore delegation with SQLiteStore delegation.
        key_points:
          - point: "Remove ChromaStore dependency"
            details: "Delete import and self._chroma"
            reference: "src/theo/storage/hybrid.py"
          - point: "Delegate to SQLiteStore methods"
            details: "add_memory, search_hybrid, get_memory, delete_memory"
            reference: "src/theo/storage/hybrid.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/storage/hybrid.py && uv run isort src/theo/storage/hybrid.py && uv run ruff check src/theo/storage/hybrid.py --fix && uv run mypy src/theo/storage/hybrid.py --ignore-missing-imports"
            exit_on_failure: true

      commit:
        type: "refactor"
        message: "Update HybridStore to use SQLiteStore instead of ChromaStore"
        files: ["src/theo/storage/hybrid.py"]

    - task_number: "8"
      name: "Update storage/__init__.py exports"
      agent: "python-pro"
      files:
        - "src/theo/storage/__init__.py"
      depends_on: [3, 7]

      success_criteria:
        - "ChromaStore removed from imports and __all__"
        - "SQLiteStore, SQLiteStoreError exported"
        - "HybridStore, HybridStoreError exported"
        - "Document, SearchResult, HybridSearchResult, StoreStats exported"
        - "StorageError = SQLiteStoreError alias added for backwards compatibility"
        - "Module docstring updated to describe sqlite-vec instead of ChromaDB"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.storage import SQLiteStore, HybridStore, Document; print(SQLiteStore)'"

      runtime_metadata:
        dependency_checks:
          - command: "cat /Users/harrison/Documents/Github/theo/src/theo/storage/__init__.py"
            description: "Check current exports"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: Single Source of Truth (one store export).
        PYTHONIC: Clean __all__, explicit imports.
        </mandatory_principles>

        <task_description>
        Update package exports:

        Remove:
        - from theo.storage.chroma_store import ChromaStore, StorageError
        - "ChromaStore" from __all__

        Keep:
        - SQLiteStore, SQLiteStoreError
        - HybridStore
        - Document, SearchResult, HybridSearchResult, StoreStats

        Add: StorageError = SQLiteStoreError (backwards compat alias)
        Update docstring - remove ChromaDB, describe sqlite-vec.
        </task_description>

      implementation:
        approach: |
          Simple import cleanup.
        key_points:
          - point: "Remove ChromaStore import"
            details: "Delete the import line"
            reference: "src/theo/storage/__init__.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/storage/__init__.py && uv run isort src/theo/storage/__init__.py && uv run ruff check src/theo/storage/__init__.py --fix"
            exit_on_failure: true

      commit:
        type: "refactor"
        message: "Update storage exports - remove ChromaStore"
        files: ["src/theo/storage/__init__.py"]

    # =========================================================================
    # ENTRY POINT GROUP
    # =========================================================================
    - task_number: "9"
      name: "Update __main__.py to use SQLiteStore"
      agent: "python-pro"
      files:
        - "src/theo/__main__.py"
      depends_on: [6, 8]

      success_criteria:
        - "ChromaStore initialization removed from initialize_components()"
        - "SQLiteStore used for all memory/vector operations"
        - "HybridStore creation updated to pass only SQLiteStore + embedder"
        - "--db-path argument removed from parse_arguments()"
        - "--collection argument removed from parse_arguments()"
        - "_require_env('THEO_DB_PATH') removed"
        - "_require_env('THEO_COLLECTION') removed"
        - "Tool instances receive SQLiteStore where ChromaStore was used"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.__main__ import initialize_components; print(\"imports ok\")'"

      runtime_metadata:
        dependency_checks:
          - command: "grep -n 'ChromaStore\\|chroma' /Users/harrison/Documents/Github/theo/src/theo/__main__.py || echo 'No refs'"
            description: "Find ChromaDB references"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: KISS, Single Source of Truth (SQLiteStore only).
        PYTHONIC: Clean initialization, proper dependency injection.
        </mandatory_principles>

        <task_description>
        Update MCP server entry point:

        In parse_arguments():
        - Remove --db-path argument (was ChromaDB path)
        - Remove --collection argument
        - Remove _require_env("THEO_DB_PATH")
        - Remove _require_env("THEO_COLLECTION")

        In initialize_components():
        - Remove step 2 (ChromaStore initialization)
        - SQLiteStore now handles memories/vectors (already handles edges)
        - Update HybridStore creation - pass only SQLiteStore + embedder
        - Update tool instantiation - pass SQLiteStore where ChromaStore was used
        </task_description>

      implementation:
        approach: |
          Simplify initialization by removing ChromaStore.
        key_points:
          - point: "Remove ChromaStore initialization"
            details: "Delete the ChromaStore step in initialize_components"
            reference: "src/theo/__main__.py:initialize_components"
          - point: "Update HybridStore creation"
            details: "Pass only sqlite_store and embedder"
            reference: "src/theo/__main__.py:initialize_components"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/__main__.py && uv run isort src/theo/__main__.py && uv run ruff check src/theo/__main__.py --fix && uv run mypy src/theo/__main__.py --ignore-missing-imports"
            exit_on_failure: true

      commit:
        type: "refactor"
        message: "Update __main__.py to use SQLiteStore only"
        files: ["src/theo/__main__.py"]

    # =========================================================================
    # CONSUMERS GROUP
    # =========================================================================
    - task_number: "5"
      name: "Update validation/ to use SQLiteStore"
      agent: "python-pro"
      files:
        - "src/theo/validation/golden_rules.py"
        - "src/theo/validation/loop.py"
        - "src/theo/validation/feedback.py"
      depends_on: [9]

      success_criteria:
        - "ChromaStore imports replaced with SQLiteStore"
        - "ValidationLoop uses SQLiteStore for confidence updates"
        - "Golden rules check: confidence >= 0.9 OR memory_type == 'golden_rule'"
        - "is_golden_rule() uses SQLiteStore.get_memory()"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.validation import ValidationLoop; print(ValidationLoop)'"

      runtime_metadata:
        dependency_checks:
          - command: "grep -rn 'ChromaStore\\|chroma' /Users/harrison/Documents/Github/theo/src/theo/validation/ || echo 'No refs'"
            description: "Find ChromaStore references"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: KISS, Fail Fast.
        PYTHONIC: Type hints, clean imports.
        </mandatory_principles>

        <golden_rules_logic>
        GOLDEN_RULE_THRESHOLD = 0.9

        A memory is a golden rule if:
        - memory_type == 'golden_rule' OR
        - confidence >= 0.9

        Promotable types: preference, decision, pattern
        When confidence reaches 0.9, these become golden rules.

        The migration preserves confidence values exactly, so golden rules
        are automatically preserved.
        </golden_rules_logic>

        <task_description>
        Update validation modules to use SQLiteStore:

        For each file that imports ChromaStore:
        1. Replace import with SQLiteStore
        2. Update type hints
        3. Update method calls:
           - store.update() → store.update_memory()
           - store.get() → store.get_memory()

        In golden_rules.py:
        - is_golden_rule(memory_id) checks:
          memory = store.get_memory(memory_id)
          return memory['confidence'] >= 0.9 or memory['memory_type'] == 'golden_rule'
        </task_description>

      implementation:
        approach: |
          Find and replace ChromaStore with SQLiteStore.
        key_points:
          - point: "Update ValidationLoop"
            details: "Use SQLiteStore.update_memory() for confidence"
            reference: "src/theo/validation/loop.py"
          - point: "Update golden_rules"
            details: "Use SQLiteStore.get_memory() for confidence check"
            reference: "src/theo/validation/golden_rules.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/validation/ && uv run isort src/theo/validation/ && uv run ruff check src/theo/validation/ --fix && uv run mypy src/theo/validation/ --ignore-missing-imports"
            exit_on_failure: true

      commit:
        type: "refactor"
        message: "Update validation modules to use SQLiteStore"
        files: ["src/theo/validation/**"]

    - task_number: "10"
      name: "Update tools/ to use SQLiteStore"
      agent: "python-pro"
      files:
        - "src/theo/tools/memory_tools.py"
        - "src/theo/tools/query_tools.py"
        - "src/theo/tools/indexing_tools.py"
        - "src/theo/tools/management_tools.py"
      depends_on: [9]

      success_criteria:
        - "ChromaStore imports replaced with SQLiteStore in all 4 files"
        - "memory_tools.py: memory_store uses add_memory(), memory_recall uses search_hybrid(), memory_forget uses delete_memory()"
        - "query_tools.py: search() uses SQLiteStore.search_hybrid()"
        - "indexing_tools.py: index operations use SQLiteStore.add_memory()"
        - "management_tools.py: get_stats uses count_memories() and list_memories()"
        - "Type hints updated from ChromaStore to SQLiteStore"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.tools import MemoryTools, QueryTools; print(MemoryTools, QueryTools)'"

      runtime_metadata:
        dependency_checks:
          - command: "grep -rn 'ChromaStore\\|chroma' /Users/harrison/Documents/Github/theo/src/theo/tools/ || echo 'No refs'"
            description: "Find ChromaStore references"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: KISS, DRY (consistent method names).
        PYTHONIC: Type hints, clean imports.
        </mandatory_principles>

        <task_description>
        Update all tool modules to use SQLiteStore:

        Method mapping:
        - store.add_documents() → store.add_memory()
        - store.search() → store.search_hybrid()
        - store.get() → store.get_memory()
        - store.delete() → store.delete_memory()
        - store.update() → store.update_memory()

        For each file:
        1. Replace ChromaStore import with SQLiteStore
        2. Update type hints for store parameter
        3. Update method calls per mapping above
        </task_description>

      implementation:
        approach: |
          Systematic find-replace in all tool files.
        key_points:
          - point: "Update memory_tools.py"
            details: "memory_store, memory_recall, memory_forget"
            reference: "src/theo/tools/memory_tools.py"
          - point: "Update query_tools.py"
            details: "search() uses search_hybrid()"
            reference: "src/theo/tools/query_tools.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black src/theo/tools/ && uv run isort src/theo/tools/ && uv run ruff check src/theo/tools/ --fix && uv run mypy src/theo/tools/ --ignore-missing-imports"
            exit_on_failure: true

      commit:
        type: "refactor"
        message: "Update all tools to use SQLiteStore"
        files: ["src/theo/tools/**"]

    # =========================================================================
    # CLEANUP GROUP
    # =========================================================================
    - task_number: "11"
      name: "Delete chroma_store.py"
      agent: "python-pro"
      files:
        - "src/theo/storage/chroma_store.py"
      depends_on: [4, 8]

      success_criteria:
        - "chroma_store.py file deleted"
        - "No remaining imports of chroma_store in codebase"
        - "All imports still work after deletion"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && test ! -f src/theo/storage/chroma_store.py && echo 'Deleted'"
        - "cd /Users/harrison/Documents/Github/theo && grep -r 'chroma_store' src/theo/ && exit 1 || echo 'No refs'"
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.storage import SQLiteStore; print(\"OK\")'"

      runtime_metadata:
        dependency_checks:
          - command: "grep -rn 'from theo.storage.chroma_store' /Users/harrison/Documents/Github/theo/src/ || echo 'None'"
            description: "Verify no imports remain"
        documentation_targets: []

      description: |
        <mandatory_principles>
        CODE REDUCTION: Delete 825 lines of ChromaDB code.
        </mandatory_principles>

        <task_description>
        Delete ChromaDB storage implementation:

        1. Verify no remaining imports: grep -r 'chroma_store' src/theo/
        2. Delete: rm src/theo/storage/chroma_store.py
        3. Verify imports work: python -c 'from theo.storage import SQLiteStore'

        This removes ~825 lines of code.
        </task_description>

      implementation:
        approach: |
          Verify no references, then delete file.
        key_points:
          - point: "Verify no imports"
            details: "grep for chroma_store references"
            reference: "src/theo/"
          - point: "Delete file"
            details: "rm src/theo/storage/chroma_store.py"
            reference: "src/theo/storage/chroma_store.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run python -c 'import theo.storage'"
            exit_on_failure: true

      commit:
        type: "refactor"
        message: "Delete ChromaDB storage (replaced by sqlite-vec)"
        files: ["src/theo/storage/chroma_store.py"]

    - task_number: "12"
      name: "Create migration script"
      agent: "database-optimizer"
      files:
        - "scripts/migrate_to_sqlite_vec.py"
      depends_on: [11]

      success_criteria:
        - "Migration script at scripts/migrate_to_sqlite_vec.py"
        - "Creates backup of theo.db and chroma_db before migration"
        - "Verifies edges table preserved (already in SQLite, no migration needed)"
        - "Verifies validation_events table preserved (already in SQLite)"
        - "Extracts memories from ChromaDB (if readable)"
        - "Migrates ALL 16 metadata fields per exact mapping table"
        - "Re-embeds content using MLX if ChromaDB corrupted"
        - "Preserves confidence values exactly (golden rules >= 0.9)"
        - "Populates embedding_cache with all embeddings"
        - "FTS5 index built automatically via INSERT into memories_fts"
        - "Verifies golden rule count matches before/after migration"
        - "Handles partial migration failure gracefully with rollback"
        - "--dry-run flag shows what would be migrated without changes"
        - "Progress logging shows migration status"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run python scripts/migrate_to_sqlite_vec.py --dry-run || echo 'Dry run'"

      runtime_metadata:
        dependency_checks:
          - command: "mkdir -p /Users/harrison/Documents/Github/theo/scripts"
            description: "Ensure scripts dir exists"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: Fail Fast (verify at each step), Single Source of Truth.
        PYTHONIC: Type hints, logging, argparse for CLI.
        </mandatory_principles>

        <exact_field_mapping>
        ChromaDB → SQLite migration (CRITICAL - follow exactly):

        | ChromaDB                | SQLite Column       | Notes                    |
        |-------------------------|---------------------|--------------------------|
        | id                      | memories.id         | Primary key              |
        | document (content)      | memories.content    | Text content             |
        | embedding               | memories_vec + cache| Re-embed if corrupted    |
        | metadata.namespace      | memories.namespace  | Direct copy              |
        | metadata.doc_type       | memories.memory_type| RENAMED                  |
        | metadata.confidence     | memories.confidence | CRITICAL for golden rules|
        | metadata.importance     | memories.importance | Direct copy              |
        | metadata.source_file    | memories.source_file| Direct copy              |
        | metadata.doc_hash       | memories.content_hash| RENAMED                 |
        | metadata.chunk_index    | memories.chunk_index| Direct copy              |
        | metadata.start_line     | memories.start_line | Direct copy              |
        | metadata.end_line       | memories.end_line   | Direct copy              |
        | metadata.created_at     | memories.created_at | ISO string → unix float  |
        | metadata.accessed_at    | memories.last_accessed| RENAMED, ISO → unix    |
        | metadata.access_count   | memories.access_count| Direct copy             |
        | metadata.meta_*         | memories.tags       | Collect as JSON dict     |
        </exact_field_mapping>

        <embedding_recovery>
        1. If ChromaDB readable: Extract embeddings directly (no re-computation)
        2. If ChromaDB corrupted: Re-embed from text using MLX
        3. Store all embeddings in embedding_cache by content_hash
        </embedding_recovery>

        <golden_rules_preservation>
        GOLDEN_RULE_THRESHOLD = 0.9
        After migration, verify: SELECT COUNT(*) FROM memories WHERE confidence >= 0.9
        This count should match pre-migration golden rule count.
        </golden_rules_preservation>

        <rollback_plan>
        If migration fails:
        1. Restore: cp ~/.theo/theo.db.backup ~/.theo/theo.db
        2. Restore: cp -r ~/.theo/chroma_db.backup ~/.theo/chroma_db
        3. Revert code via git
        </rollback_plan>

        <task_description>
        Create migration script:

        ```python
        # scripts/migrate_to_sqlite_vec.py
        import argparse
        import logging
        from pathlib import Path

        def backup(theo_path: Path) -> None:
            """Create backups of theo.db and chroma_db."""

        def extract_from_chromadb(chroma_path: Path) -> list[dict]:
            """Extract all documents with metadata from ChromaDB."""

        def migrate_memory(doc: dict, sqlite_store, embedder) -> None:
            """Migrate single memory with exact field mapping."""

        def verify_golden_rules(sqlite_store, expected_count: int) -> bool:
            """Verify golden rules preserved."""

        def main():
            parser = argparse.ArgumentParser()
            parser.add_argument('--dry-run', action='store_true')
            args = parser.parse_args()

            # 1. Backup
            # 2. Extract from ChromaDB
            # 3. Migrate each memory with exact field mapping
            # 4. Build FTS index (automatic via INSERT)
            # 5. Verify golden rules
        ```
        </task_description>

      implementation:
        approach: |
          Read from ChromaDB, write to SQLite with exact mapping.
        key_points:
          - point: "Backup before migration"
            details: "Copy theo.db and chroma_db to .backup"
            reference: "scripts/migrate_to_sqlite_vec.py"
          - point: "Exact field mapping"
            details: "Follow table above precisely"
            reference: "scripts/migrate_to_sqlite_vec.py"
          - point: "Verify golden rules"
            details: "Count confidence >= 0.9 before and after"
            reference: "scripts/migrate_to_sqlite_vec.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run black scripts/migrate_to_sqlite_vec.py && uv run isort scripts/migrate_to_sqlite_vec.py && uv run ruff check scripts/migrate_to_sqlite_vec.py --fix"
            exit_on_failure: true

      commit:
        type: "feat"
        message: "Add ChromaDB to sqlite-vec migration script"
        files: ["scripts/migrate_to_sqlite_vec.py"]

    - task_number: "13"
      name: "Update tests for sqlite-vec"
      agent: "test-automator"
      files:
        - "tests/test_sqlite_store.py"
      depends_on: [11]

      success_criteria:
        - "tests/test_sqlite_store.py exists with comprehensive tests"
        - "tests/test_chroma_store.py deleted or renamed"
        - "Tests cover CRUD: add_memory, get_memory, update_memory, delete_memory"
        - "Tests cover list_memories and count_memories with filters"
        - "Tests cover search_vector, search_fts, search_hybrid"
        - "Tests cover embedding cache: get_cached_embedding, cache_embedding"
        - "Tests cover golden rule threshold (confidence >= 0.9)"
        - "Tests cover edge operations (add_edge, get_edges, delete_edge)"
        - "Tests use in-memory SQLite (':memory:') with sqlite-vec extension"
        - "Mock embeddings use [0.1] * 1024 for 1024-dim vectors"
        - "All tests pass with uv run pytest tests/test_sqlite_store.py -v"
        - "No TODO comments"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv run pytest tests/test_sqlite_store.py -v"

      runtime_metadata:
        dependency_checks:
          - command: "ls /Users/harrison/Documents/Github/theo/tests/test_*store*.py || echo 'None'"
            description: "Check existing tests"
        documentation_targets: []

      description: |
        <mandatory_principles>
        ENGINEERING: DRY (shared fixtures), Fail Fast.
        PYTHONIC: pytest fixtures, parametrize for variations.
        </mandatory_principles>

        <task_description>
        Create comprehensive tests for SQLiteStore:

        Fixture:
        ```python
        @pytest.fixture
        def store():
            s = SQLiteStore(":memory:")
            yield s
            s.close()
        ```

        Test cases:
        1. test_add_and_get_memory
        2. test_update_memory_confidence
        3. test_delete_memory
        4. test_search_vector_knn
        5. test_search_fts_match
        6. test_search_hybrid_combined
        7. test_embedding_cache_hit
        8. test_embedding_cache_miss
        9. test_golden_rule_confidence_threshold

        Use mock embeddings (list of 1024 floats).
        </task_description>

      implementation:
        approach: |
          pytest with fixtures and parametrize.
        key_points:
          - point: "In-memory SQLiteStore fixture"
            details: "SQLiteStore(':memory:') with sqlite-vec"
            reference: "tests/test_sqlite_store.py"
          - point: "Mock embeddings"
            details: "[0.1] * 1024 for test vectors"
            reference: "tests/test_sqlite_store.py"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv run pytest tests/test_sqlite_store.py -v"
            exit_on_failure: true

      commit:
        type: "test"
        message: "Add comprehensive tests for SQLiteStore with sqlite-vec"
        files: ["tests/test_sqlite_store.py"]

    - task_number: "14"
      name: "Remove chromadb dependency"
      agent: "python-pro"
      files:
        - "pyproject.toml"
      depends_on: [11, 13]

      success_criteria:
        - "chromadb>=0.4.0 removed from [project].dependencies"
        - "chromadb.* removed from [[tool.mypy.overrides]] module list"
        - "grep -r 'chromadb' src/theo/ returns no matches"
        - "grep -r 'ChromaStore' src/theo/ returns no matches"
        - "uv sync --dev succeeds without chromadb"
        - "uv run python -c 'from theo.storage import SQLiteStore' succeeds"
        - "uv run pytest tests/ -v passes all tests"

      test_commands:
        - "cd /Users/harrison/Documents/Github/theo && uv sync --dev"
        - "cd /Users/harrison/Documents/Github/theo && uv run python -c 'from theo.storage import SQLiteStore; print(\"OK\")'"
        - "cd /Users/harrison/Documents/Github/theo && uv run pytest tests/ -v --ignore=tests/test_migration.py"

      runtime_metadata:
        dependency_checks:
          - command: "grep -r 'chromadb' /Users/harrison/Documents/Github/theo/src/ || echo 'None'"
            description: "Verify no chromadb imports"
        documentation_targets: []

      description: |
        <mandatory_principles>
        CODE REDUCTION: Remove unused dependency.
        </mandatory_principles>

        <overall_success_criteria>
        Final verification (from original plan Part 9):
        - [ ] All existing memories recoverable
        - [ ] Edge relationships preserved
        - [ ] Validation history preserved
        - [ ] Hybrid search returns relevant results
        - [ ] Embedding cache reduces re-computation by >90%
        - [ ] No corruption under concurrent access
        - [ ] All tests passing
        - [ ] Hook-based injection continues to work
        </overall_success_criteria>

        <task_description>
        Remove chromadb dependency:

        1. In pyproject.toml [project].dependencies:
           Delete: "chromadb>=0.4.0",

        2. In [[tool.mypy.overrides]]:
           Remove "chromadb.*" from module list

        3. Run: uv sync --dev
        4. Run: uv run pytest tests/ -v
        5. Verify all success criteria above
        </task_description>

      implementation:
        approach: |
          Remove lines from pyproject.toml.
        key_points:
          - point: "Remove chromadb dependency"
            details: "Delete from dependencies list"
            reference: "pyproject.toml"
          - point: "Remove mypy override"
            details: "Delete chromadb.* from overrides"
            reference: "pyproject.toml"

      code_quality:
        python:
          full_quality_pipeline:
            command: "cd /Users/harrison/Documents/Github/theo && uv sync --dev && uv run pytest tests/ -v --ignore=tests/test_migration.py"
            exit_on_failure: true

      commit:
        type: "build"
        message: "Remove chromadb dependency - migration complete"
        files: ["pyproject.toml", "uv.lock"]
